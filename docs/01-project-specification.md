# Diary Platform - Project Specification & Context

**Last Updated**: October 31, 2025  
**Phase**: Architecture & Design  
**Development Approach**: AI-assisted (Claude Code)  
**Developer Level**: Senior

---

## üéØ Project Vision

A privacy-first diary platform that serves as the **source of truth** for all user social media content. Users can:
- Create private diary entries (text + photos)
- Selectively push entries to social platforms (starting with Facebook)
- Pull historical and new posts from social platforms back into diary
- Maintain complete control over their data with end-to-end encryption
- Use diary as central hub - compose once, distribute everywhere

---

## ‚úÖ Architectural Decisions Made

### Core Architecture
- **Pattern**: Microservices architecture
- **MVP Deployment**: Docker + Docker Compose (no Kubernetes initially)
- **Post-MVP**: Kubernetes migration when scale demands it
- **Backend**: Python 3.11+ with FastAPI (or agent's choice)
- **Database**: PostgreSQL 15+ (or agent's choice)
- **Caching/Queue**: Redis + Celery for async tasks (or agent's choice)
- **ORM**: SQLAlchemy 2.0 (if Python)
- **Media Storage**: S3 with pluggable storage adapter pattern
- **User Authentication**: OAuth2

### Integration Strategy
- **First Integration**: Facebook (push then pull)
- **Architecture**: Common interface/abstraction layer for all social platforms
- **Sync Mode**: Real-time where possible
- **OAuth Flow**: Integration tokens managed server-side
- **Deduplication**: Hybrid approach using external IDs + content hashes

### Client Applications
- **Platforms**: Mobile-first (iOS, Android) + Web (PWA)
- **Architecture**: Thin clients, API does heavy lifting
- **Encryption**: Client-side encryption/decryption

---

## üîê Security & Privacy Model - DUAL TIER APPROACH

### Critical Innovation: User Chooses Encryption Model

Users select their encryption tier at signup (permanent decision):

**Tier 1: E2E (End-to-End Encrypted)**
- Keys never leave client device
- Server cannot decrypt user content
- Maximum privacy guarantee
- Limited server-side features
- Recovery via recovery codes only

**Tier 2: UCE (User-Controlled Encryption)**
- Encrypted at rest with user password-derived keys
- Server stores encrypted master key (encrypted with user password)
- Server can decrypt with user password
- Enables account recovery, multi-device sync, server-side features
- Still provides strong privacy guarantees
- More practical for MVP while maintaining privacy-first positioning

### Why Dual-Tier?

**Market Positioning:**
- Attract BOTH privacy advocates AND mainstream users
- "Privacy when you need it, convenience when you want it"
- User has explicit choice and control
- Most competitive platforms don't offer this choice

**Technical Feasibility:**
- Strategy pattern for encryption services
- Feature gate system for tier-specific capabilities
- Shared core platform
- Clean separation of concerns

### Encryption Approach Details

#### E2E Tier Specifics

**Key Derivation**: Public key cryptography (X25519 or similar)

**Key Storage:**
- iOS: Keychain
- Android: KeyStore
- Web: IndexedDB with Web Crypto API

**Recovery Method:**
- 10 recovery codes generated at signup
- User MUST save codes
- No other recovery mechanism

**Multi-Device Sync:**
- Manual key transfer via QR code
- Or recovery code entry on new device

#### UCE Tier Specifics

**Key Derivation**: Argon2id (modern, secure password hashing)

**Key Storage:**
- Master encryption key generated by server
- Master key encrypted with password-derived key
- Encrypted master key stored in database
- Any device with password can derive key ‚Üí decrypt master key ‚Üí access data

**Recovery Method:**
- Standard password reset via email
- Security questions (optional)
- Recovery codes (optional additional security)

**Multi-Device Sync:**
- Automatic with password
- No manual key transfer needed

**Trade-offs Accepted**:
- Server is trusted party (can decrypt with user password)
- Enables: search, sharing, easier multi-device sync, account recovery
- User data still encrypted at rest, strong security model

### Multi-Device Key Sync Flow (UCE)
```
Flow:
1. User creates account with password
2. System generates master encryption key
3. Master key encrypted with password-derived key (Argon2id)
4. Encrypted master key stored on server
5. Any device: user enters password ‚Üí derives key ‚Üí decrypts master key ‚Üí access to all data
```

---

## üìä Data Model Concepts

### Core Entities

**User**
- Unique ID
- Email (unique)
- Password hash
- **Encryption tier (enum: E2E or UCE)** - SET AT SIGNUP, IMMUTABLE
- Created/updated timestamps
- Tier-specific fields:
  - E2E: public_key, recovery_code_hashes
  - UCE: encrypted_master_key, key_derivation_salt

**Entry** (encrypted)
- Unique ID
- User reference
- Encrypted content (text)
- Content hash (SHA256 - for deduplication)
- Encrypted media references
- Source tag (diary, facebook, instagram, etc.)
- Timestamps (created, updated)
- User-defined tags + auto-tags
- Soft delete flag

**External_Posts** (mapping table - plaintext metadata)
- Entry ID reference
- Platform (facebook, instagram, etc.)
- External post ID
- External URL
- Posted timestamp
- Sync status

**Entry_Events** (audit/history trail)
- Event type (created, edited, pushed, pulled, tagged)
- Timestamp
- Changes/metadata
- Enables version history, "git-like" functionality

**Media** (encrypted blobs)
- Entry reference
- Encrypted file data (or S3 key)
- File hash
- MIME type
- File size
- Dimensions/duration (if applicable)

**Integration_Accounts**
- User reference
- Platform
- OAuth tokens (encrypted)
- Token expiration
- Configuration/preferences
- Status (active, expired, revoked)

**Tags**
- Entry reference
- Tag name
- Auto-generated flag

**E2E_Public_Keys** (E2E tier only)
- User reference
- Public key
- Device keys (for multi-device, future)

**E2E_Recovery_Codes** (E2E tier only)
- User reference
- Code hash
- Used flag
- Used timestamp

---

## üîÑ Facebook Integration Flows

### Phase 1: Push to Facebook

**User Flow**:
1. User creates diary entry (encrypted, saved)
2. User selects entry, clicks "Share to Facebook"
3. User chooses what to share (full text, photos, edited version)
4. Client decrypts entry (E2E) or requests decrypted (UCE)
5. Client/server sends plaintext to Facebook Graph API
6. API stores external_post mapping (entry_id ‚Üí facebook_post_id)
7. Entry tagged with "shared:facebook"

**User Controls**:
- Select which entries to share
- Edit before sharing
- Choose Facebook privacy settings
- Single photos or albums

### Phase 2: Pull from Facebook

**User Flow**:
1. User clicks "Import from Facebook"
2. API fetches posts via Graph API (paginated, with historical data)
3. For each Facebook post:
   - Check if external_post_id exists ‚Üí skip (already imported)
   - Check content_hash match ‚Üí skip (duplicate)
   - New post ‚Üí create diary entry
4. If E2E tier:
   - Server returns plaintext to client
   - Client encrypts and saves
5. If UCE tier:
   - Server encrypts and saves
   - Client receives encrypted entries
6. Auto-tag entries with "source:facebook"

**Deduplication Logic**:
```
Priority order:
1. Match external_post_id (pushed from diary originally)
2. Match content_hash (same content posted manually)
3. No match ‚Üí create new entry
```

**Historical Import**: Support pagination to fetch old posts (configurable date range)

---

## üèóÔ∏è Microservices Architecture (MVP)

### Service Breakdown

**1. Core API Service**
- User authentication (OAuth2)
- Entry CRUD operations
- Tag management
- Encryption key management
- Client-facing REST/GraphQL endpoints
- Encryption tier routing

**2. Integration Service**
- Facebook connector (initial)
- Common integration interface
- OAuth flow handling
- Platform-specific adapters
- Sync orchestration

**3. Background Worker Service**
- Async Facebook imports
- Scheduled sync jobs
- Media processing
- Retry logic for failed operations

**4. Storage Service** (Abstraction Layer)
- S3 primary implementation
- Pluggable adapter pattern (Google Cloud Storage, Azure, local)
- Encrypted media handling
- Pre-signed URL generation

### Service Communication
- REST between services (simpler for MVP)
- Shared Redis for caching/queues
- Shared PostgreSQL (separate schemas per service)

### MVP Deployment Strategy
- **Docker** containers for each service
- **Docker Compose** for orchestration
- Simple infrastructure (VPS or cloud VM)
- No Kubernetes complexity initially
- Easy to run locally for development

### Post-MVP Migration to Kubernetes
- Microservices architecture already prepared
- Minimal code changes needed
- Migrate when scale demands:
  - Thousands of active users
  - High traffic volumes
  - Need for auto-scaling
  - Geographic distribution

---

## üé® User Experience Principles

### Encryption Tier Selection (Signup)
- Clear visual comparison (two cards side-by-side)
- Explain capabilities and limitations
- Warn about permanence of choice
- Default suggestion: UCE for most users
- E2E tier requires saving recovery codes (forced step)

### Privacy Controls
- Default: entries are private
- Explicit opt-in to share
- Clear visual indicators (lock icons, "shared" badges)
- Granular permissions per platform

### Tagging System
- Auto-tags: `source:facebook`, `source:diary`, `shared:facebook`
- User can add custom tags
- Tags are searchable/filterable
- Tag suggestions based on content

### Editing & Sync
- If user edits entry already pushed to Facebook:
  - Show "Out of sync with Facebook" indicator
  - Offer: "Update Facebook post" button
  - User chooses whether to sync edit

### History / Version Control
- Event sourcing provides audit trail
- UI: "View History" shows timeline of changes
- Can see: when created, when edited, when shared, when pulled
- User-friendly git-like functionality without complexity

### Feature Availability Indicators
- E2E users see "Local search only" message
- UCE users see "Full-text search available"
- Clear tier badge in UI (lock icon for E2E, shield for UCE)

---

## üìà MVP Storage & Limits

### Tier Structure (4 Tiers Total)
| Tier | Storage | Price | Target User |
|------|---------|-------|-------------|
| E2E Free | 1GB | $0 | Privacy enthusiasts (trial) |
| E2E Paid | 50GB | $8/mo | Privacy power users |
| UCE Free | 1GB | $0 | Casual journalers (trial) |
| UCE Paid | 50GB | $8/mo | Power users |

**Philosophy**: Same price for both encryption models. Privacy is not a premium.

### Why These Limits
- 1GB ‚âà 1,000 photos (enough for casual users)
- Drives conversion for power users
- S3 cost: ~$0.023/GB/month (manageable)

### Enforcement
- Track total encrypted media size per user
- Check limits before accepting uploads
- Graceful degradation (can still create text entries)

---

## üîß Technology Stack Summary (Recommendations)

### Backend (Agent Chooses)
- **Language**: Python 3.11+ / Node.js / Go
- **API Framework**: FastAPI (Python) / Express (Node) / Gin (Go)
- **ORM**: SQLAlchemy 2.0 (Python) / Prisma (Node) / GORM (Go)
- **Database**: PostgreSQL 15+ / MySQL 8+
- **Cache/Queue**: Redis + Celery/Bull/similar
- **Authentication**: OAuth2 (JWT tokens)

### Infrastructure (MVP)
- **Containers**: Docker
- **Orchestration**: Docker Compose (MVP) ‚Üí Kubernetes (post-MVP)
- **Hosting**: AWS/GCP/Azure/DigitalOcean
- **Storage**: S3 (or compatible)
- **CI/CD**: GitHub Actions / GitLab CI

### External APIs
- **Facebook**: Graph API v18+ (OAuth + posting/reading)
- **Future**: Instagram, Twitter/X, LinkedIn APIs

### Mobile Platforms
- **iOS**: Swift/SwiftUI (native) or React Native
- **Android**: Kotlin/Jetpack Compose (native) or React Native
- **Web**: React/Vue/Svelte + PWA capabilities

---

## üöß Open Questions & Decisions Needed

### High Priority
1. **Backend language?** Python / Node.js / Go / Other
2. **Database choice?** PostgreSQL / MySQL / Other
3. **File storage?** AWS S3 / GCP Storage / Azure Blob / Other
4. **Mobile approach?** Native (Swift/Kotlin) / React Native / Flutter
5. **Web framework?** React / Vue / Svelte / Other

### Medium Priority
6. **Search Implementation**: PostgreSQL FTS or Elasticsearch?
7. **Real-time sync**: Polling or WebSockets?
8. **Sharing Between Users**: Can users share diary entries with each other?
9. **Export Format**: What formats for data export? (JSON, PDF, ZIP?)
10. **Media Compression**: Compress before encrypt? What quality settings?

### Low Priority (Post-MVP)
11. **Analytics**: What user behavior to track (privacy-respecting)?
12. **Collaboration**: Multiple users on one diary entry?
13. **AI Features**: Auto-tagging, sentiment analysis, etc.?
14. **Mobile Offline Mode**: Full offline support or online-only?

---

## üìã Next Steps - Spec Documents to Create

### Immediate
1. **Client Application Architecture Spec**
   - iOS app implementation guide
   - Android app implementation guide
   - Web app (PWA) implementation guide
   - Client-side encryption details
   - Local database strategies

2. **Facebook Integration Service Spec**
   - OAuth flow with Facebook
   - Push implementation (Graph API)
   - Pull implementation (pagination, dedup)
   - Error handling & retry logic

### Soon
3. **Search Implementation Spec**
   - UCE: Server-side search architecture
   - E2E: Client-side search strategies
   - Performance optimization
   - Indexing approaches

4. **Multi-Device Sync Spec**
   - UCE: Automatic sync protocol
   - E2E: Manual device pairing
   - Conflict resolution
   - Offline support

### Later
5. **Deployment & Operations Spec**
   - Docker Compose setup
   - Environment configuration
   - Secrets management
   - Monitoring & alerting
   - Migration path to Kubernetes

6. **Storage & Media Management Spec**
   - File encryption approaches
   - Storage adapter pattern
   - Limit enforcement
   - Media optimization

---

## üéØ Success Metrics (MVP)

### User Metrics
- Users can create encrypted diary entries
- Users can push entries to Facebook
- Users can pull historical posts from Facebook
- Zero data breaches (encrypted at rest)
- Account recovery works reliably
- Users understand their encryption tier choice

### Technical Metrics
- API response time < 200ms (95th percentile)
- Facebook sync success rate > 95%
- Encryption/decryption < 50ms per entry
- Background job processing < 5min per 100 posts

### Business Metrics
- Free-to-paid conversion rate (goal: 5-10%)
- User retention D7, D30
- Feature usage (push vs. pull)
- Tier selection split (E2E vs UCE)

---

## üìö Reference Documentation

### Facebook Graph API
- [Graph API Reference](https://developers.facebook.com/docs/graph-api)
- [Permissions Reference](https://developers.facebook.com/docs/permissions/reference)
- [User Posts](https://developers.facebook.com/docs/graph-api/reference/user/posts)

### Security/Encryption
- [Argon2 Specification](https://github.com/P-H-C/phc-winner-argon2)
- [OWASP Cryptographic Storage](https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html)

---

## ü§ù Contributing (for AI Agents)

When generating code for this project:
1. Follow spec-driven development
2. Include comprehensive error handling
3. Add detailed docstrings
4. Write unit tests for all functions
5. Use type hints (language-appropriate)
6. Security-first mindset (validate all inputs)
7. Privacy-first (never log sensitive data)
8. Respect encryption tier differences

---

## üìù Notes & Decisions Log

| Date | Decision | Rationale |
|------|----------|-----------|
| 2025-10-31 | Dual-tier encryption (E2E + UCE) | Market differentiation, user choice, attracts both segments |
| 2025-10-31 | Mobile-first (iOS, Android, Web) | User behavior, diary is personal/mobile activity |
| 2025-10-31 | Docker Compose for MVP | Simpler deployment, easier development, migrate to K8s later |
| 2025-10-31 | Microservices architecture | Scalable, separation of concerns, ready for K8s when needed |
| 2025-10-31 | Event sourcing for history | Audit trail, version control, future-proof |
| 2025-10-31 | S3 with adapter pattern | Cost-effective, pluggable for other providers |
| 2025-10-31 | Same price for both tiers | Privacy is not a premium feature |

---

## ‚ùì Questions for Stakeholders

1. Confirm technology choices (backend language, database, mobile approach)?
2. Target market: privacy-conscious consumers? Journaling enthusiasts? Social media power users?
3. Timeline to MVP: 3 months? 6 months? (No pressure, but good to know)
4. Team size: solo developer? Small team?
5. Budget considerations for infrastructure?

---

**End of Specification Document**

*This is a living document. Update as decisions are made and architecture evolves.*
